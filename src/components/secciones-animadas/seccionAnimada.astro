---
import "./seccionAnimada.css";
---

<div id="secciones-animadas-wrapper">
  <section class="first">
    <div class="outer">
      <div class="inner">
        <div class="bg one">
          <h2 class="section-heading">Bienvenido a ESYMBEL</h2>
        </div>
      </div>
    </div>
  </section>

  <section class="second">
    <div class="outer">
      <div class="inner">
        <div class="bg">
          <h2 class="section-heading">Café de especialidad</h2>
        </div>
      </div>
    </div>
  </section>

  <section class="third">
    <div class="outer">
      <div class="inner">
        <div class="bg">
          <h2 class="section-heading">Hecho con pasión</h2>
        </div>
      </div>
    </div>
  </section>
  <section class="fifth">
    <div class="outer">
      <div class="inner">
        <div class="bg">
          <h2 class="section-heading">Descubre más</h2>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
  import gsap from 'gsap';
  import { Observer } from 'gsap/Observer';

  function initSeccionesAnimadas() {
    gsap.registerPlugin(Observer);

    const sections = document.querySelectorAll('#secciones-animadas-wrapper section');
    const images = document.querySelectorAll('#secciones-animadas-wrapper .bg');
    const headings = gsap.utils.toArray('#secciones-animadas-wrapper .section-heading');
    const outerWrappers = gsap.utils.toArray('#secciones-animadas-wrapper .outer');
    const innerWrappers = gsap.utils.toArray('#secciones-animadas-wrapper .inner');
    
    if (!sections.length) return;

    // Split text manual
    const splitHeadings = headings.map((heading) => {
      const text = (heading as HTMLElement).textContent;
      const chars = text.split('');
      (heading as HTMLElement).innerHTML = chars.map(char => 
        `<span class="char">${char === ' ' ? '&nbsp;' : char}</span>`
      ).join('');
      return {
        chars: (heading as HTMLElement).querySelectorAll('.char')
      };
    });
    
    let currentIndex = -1;
    let animating = false;
    const maxIndex = sections.length - 1;

    function resetAllSections() {
      // Resetear todos los estilos a su estado inicial
      gsap.set(sections, { autoAlpha: 0, zIndex: 0 });
      gsap.set(outerWrappers, { yPercent: 100 });
      gsap.set(innerWrappers, { yPercent: -100 });
      gsap.set(images, { yPercent: 0 });
      splitHeadings.forEach(heading => {
        gsap.set(heading.chars, { autoAlpha: 0, yPercent: 0 });
      });
    }

    resetAllSections();

    function gotoSection(index:any, direction:any) {
      animating = true;
      
      const fromTop = direction === -1;
      const dFactor = fromTop ? -1 : 1;
      const tl = gsap.timeline({
        defaults: { duration: 1.25, ease: "power1.inOut" },
        onComplete: () => { animating = false; }
      });

      if (currentIndex >= 0) {
        gsap.set(sections[currentIndex], { zIndex: 0 });
        tl.to(images[currentIndex], { yPercent: -15 * dFactor })
          .set(sections[currentIndex], { autoAlpha: 0 });
      }

      gsap.set(sections[index], { autoAlpha: 1, zIndex: 1 });
      tl.fromTo(
        [outerWrappers[index], innerWrappers[index]], 
        { yPercent: i => i ? -100 * dFactor : 100 * dFactor }, 
        { yPercent: 0 }, 
        0
      )
      .fromTo(
        images[index], 
        { yPercent: 15 * dFactor }, 
        { yPercent: 0 }, 
        0
      )
      .fromTo(
        splitHeadings[index].chars, 
        { 
          autoAlpha: 0, 
          yPercent: 150 * dFactor
        }, 
        {
          autoAlpha: 1,
          yPercent: 0,
          duration: 1,
          ease: "power2",
          stagger: {
            each: 0.02,
            from: "random"
          }
        }, 
        0.2
      );

      currentIndex = index;
    }

    // Detectar cuando el usuario llega a esta sección
    const wrapper = document.querySelector('#secciones-animadas-wrapper');
    let observerInstance:any = null;
    let lastScrollY = window.scrollY;

    const sectionObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          // Activar el Observer cuando la sección está visible
          if (!observerInstance) {
            // Detectar dirección de entrada
            const currentScrollY = window.scrollY;
            const scrollingDown = currentScrollY > lastScrollY;
            
            observerInstance = Observer.create({
              type: "wheel,touch,pointer",
              wheelSpeed: -1,
              onDown: () => {
                if (animating) return;
                
                // Si está en la primera sección y hace scroll arriba, hacer fade out y desactivar
                if (currentIndex === 0) {
                  animating = true;
                  gsap.to(sections[currentIndex], {
                    autoAlpha: 0,
                    duration: 0.6,
                    ease: "power2.inOut",
                    onComplete: () => {
                      if (observerInstance) {
                        observerInstance.kill();
                        observerInstance = null;
                      }
                      animating = false;
                    }
                  });
                  return;
                }
                
                const nextIndex = currentIndex - 1;
                gotoSection(nextIndex, -1);
              },
              onUp: () => {
                if (animating) return;
                
                // Si está en la última sección y hace scroll abajo, hacer fade out y desactivar
                if (currentIndex === maxIndex) {
                  animating = true;
                  gsap.to(sections[currentIndex], {
                    autoAlpha: 0,
                    duration: 0.6,
                    ease: "power2.inOut",
                    onComplete: () => {
                      if (observerInstance) {
                        observerInstance.kill();
                        observerInstance = null;
                      }
                      animating = false;
                    }
                  });
                  return;
                }
                
                const nextIndex = currentIndex + 1;
                gotoSection(nextIndex, 1);
              },
              tolerance: 10,
              preventDefault: true
            });
            
            // Iniciar desde la sección correcta según la dirección
            if (currentIndex === -1) {
              if (scrollingDown) {
                // Entrando desde arriba, empezar en la primera
                gotoSection(0, 1);
              } else {
                // Entrando desde abajo, empezar en la última
                gotoSection(maxIndex, -1);
              }
            }
          }
        } else {
          // Desactivar cuando no está visible y resetear completamente
          if (observerInstance) {
            observerInstance.kill();
            observerInstance = null;
          }
          // Resetear índice y estilos para la próxima vez que entre
          if (!entry.isIntersecting) {
            currentIndex = -1;
            resetAllSections();
          }
        }
        
        lastScrollY = window.scrollY;
      });
    }, { threshold: 0.5 });

    if (wrapper) {
      sectionObserver.observe(wrapper);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSeccionesAnimadas);
  } else {
    initSeccionesAnimadas();
  }

  document.addEventListener('astro:page-load', initSeccionesAnimadas);
</script>